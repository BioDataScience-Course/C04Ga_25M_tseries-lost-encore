---
title: "___"
author: "___"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
editor: visual
lang: fr
---

<!--# Ceci est un commentaire. -->

<!--% Ceci est une consigne. Ne jamais modifier ni déplacer les consignes dans le document ! -->

<!--% Complétez le titre et le nom des auteurs (auteur1, auteur2, auteur3 et auteur 4) dans l'entête YAML.-->

## Introduction et but

<!--% Rédigez une courte introduction de 3 ou 5 phrases qui présente vos données. Ajoutez une phrase de but. Vous devez citer la bibliographie en utilisant le formatage Markdown ad hoc et en incluant votre référence au format bibtex dans le fichier references.bib. -->

... Introduction et but...

## Matériel et méthodes

<!--% Indiquez ici d'où viennent les données et aussi quel logiciel (et version) vous utilisez pour les analyses. Inspirez-vous des projets déjà réalisés. -->

...Matériel et méthodes...

## Analyses

<!--% Lisez bien les éléments devant guider votre analyse proposée dans le README.-->

```{r setup, include=FALSE}
# Nécessaire pour les tests SDD, ne pas utiliser dans un "vrai" projet
if (!"tools:tests" %in% search())
  source(here::here("tests/tools_tests.R"), attach(NULL, name = "tools:tests"))
# Configuration de l'environnement
SciViews::R("ts")
```

<!--% Ajoutez le nombre de chunks que vous souhaitez. Répartissez-vous le travail correctement. Structurez la section en partie avec des titres explicites de niveau trois.-->

```{r Importation mobility wallonia rds}

read("data/mobility_wallonia.rds") -> mob
mobw <- mob
mobw$weekdays <- weekdays(as.POSIXct(mobw$date))
mobw[mobw$weekdays == "Saturday" | mobw$weekdays == "Sunday", 2:7] <- NA # Contient que les 5 jours de la semaine
mobw_ts <- ts(mobw$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
mobw_ts2 <- aggregate(mobw_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)

# Contient que le week-end
mobWE <- mob
mobWE$weekdays <- weekdays(as.POSIXct(mobWE$date))
mobWE[mobWE$weekdays != "Saturday" & mobWE$weekdays != "Sunday", 2:7] <- NA
mobWE_ts <- ts(mobWE$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
mobWE_ts2 <- aggregate(mobWE_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
```


#Présentation du jeux de données 
##Mobilité lié aux Commerces et aux loisirs 
```{r loisir et commerce présentation des données}
# Série brut, semaine
mob_loisir_brut <- ts( mob$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
plot( mob_loisir_brut, main = "Commerces et loisirs - Semaine",  ylab = "% de changement par rapport à la référence", xlab = "Temps")

#Jours ouvrables
mobw_loisir_brut <- ts(mobw$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
plot(mobw_loisir_brut, main = "Commerces et loisirs - Jours ouvrables",ylab = "% de changement par rapport à la référence", xlab = "Temps")

#WE
mobWE_loisir_brut  <- ts(mobWE$retail_and_recreation_percent_change_from_baseline,   start = c(2020, 46), frequency = 365)
plot(mobWE_loisir_brut, main = "Commerces et loisirs - week-end uniquement", ylab = "% de changement par rapport à la référence", xlab = "Temps")

#Jours ouvrable et WE supperposé 
plot(mobw_loisir_brut, main = "Commerces et loisirs  – comparaison jours ouvrables / week-end ", xlab = "Temps", ylab = "% vs baseline", lwd = 2)
lines(mobWE_loisir_brut, lwd = 2, lty = 2)
legend("topright", legend = c("Jours ouvrables", "Week-end"), lty = c(1,2), lwd = 2, bty = "n")

```
L’analyse descriptive des séries temporelles de mobilité liées aux commerces et aux loisirs en Wallonie met en évidence une chute brutale et immédiate de la mobilité au début de l’année 2020, correspondant à la mise en place des premières mesures de confinement liées à la pandémie de COVID-19.
Cette diminution est observable dans les trois séries étudiées (série complète, jours ouvrables et week-ends), mais elle apparaît plus marquée durant les week-ends que pendant les jours ouvrables. En semaine, la baisse est également présente, mais elle est plus lissée, traduisant le maintien partiel de déplacements essentiels.
À partir de l’année 2021, une reprise progressive de la fréquentation des commerces et des loisirs est observée, bien que les niveaux de mobilité ne retrouvent pas ceux de la période de référence pré-pandémique.
La distinction entre jours ouvrables et week-ends met en évidence que les activités de loisirs ont été plus fortement affectées par la crise sanitaire qu’en semaine. 
Ces différences justifient l’utilisation des méthodes d’analyse statistique adaptées aux séries temporelles pour approfondir l’étude.
#Analyse : 
##Loisir et commerces
###Préparation des données 
```{r LOISIR Hebdomadaire }
#Jours ouvrables
mobwts_LOISIR <- ts(mobw$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobwts_LOISIR, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobw_loisirs_ts
plot(mobw_loisirs_ts)
#Week-end
mobWEts_LOISIR <- ts(mobWE$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobWEts_LOISIR, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobWE_loisirs_ts
plot(mobWE_loisirs_ts)

#semaine compléte
mobts_LOISIR <- ts(mob$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobts_LOISIR, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mob_loisirs_ts
plot(mob_loisirs_ts)

#Jours ouvrable et WE suppérposé 
plot(mobwts_LOISIR, main = "Commerces et loisirs  – comparaison jours ouvrables / week-end (hebdomadaire) ", xlab = "Temps", ylab = "% vs baseline", lwd = 2)
lines(mobWEts_LOISIR, lwd = 2, lty = 2)
legend("topright", legend = c("Jours ouvrables", "Week-end"), lty = c(1,2), lwd = 2, bty = "n")

```
Ici on a fait une  agrégation hebdomadaire, pour lisser la ts et la rendre plus lisible.On voit chute importante début 2020, puis une reprise progressive à partir de 2021 et une stabilisation relative ensuite.La ts week-end a une amplitude plus grande et presente  plus de variations. 
Et celle des jours ouvrables est un  peu plus lissée et moins extrême.
##Analyse statistique
```{r Autocorrélation LOISIR}
acf(mobw_loisirs_ts, main = "ACF – LOISIR (jours de semaine, hebdomadaire)")
acf(mobWE_loisirs_ts,main = "ACF – LOISIR (week-end, hebdomadaire)")
acf(mob_loisirs_ts,main = "ACF – LOISIR (série complète, hebdomadaire)")
```
On observe toujours une chute très marquée début 2020 (premier confinement),suivie d’une reprise progressive à partir de 2021. La chute est plus brutale et plus profonde le week-end et plus lissée les jours ouvrables. Les niveaux pré-pandémiques ne sont pas totalement retrouvés. 
Cela confirme que le secteur des loisirs a été durablement affecté par la crise sanitaire.

```{r tendance locale et générale de loisir}
trend.test(mobw_loisirs_ts, R=999)->trend.test_w_loisir
plot(trend.test_w_loisir)
trend.test_w_loisir
trend.test(mobWE_loisirs_ts, R=999)->trend.test_WE_loisir
plot(trend.test_WE_loisir)
trend.test_WE_loisir
trend.test(mob_loisirs_ts,R=999)->trend.test_loisir
plot(trend.test_loisir)
trend.test_loisir

local.trend(mobw_loisirs_ts,  main = "Tendance locale – LOISIR (jours ouvrables)")->local.trend_w_loisir
local.trend(mobWE_loisirs_ts, main = "Tendance locale – LOISIR (week-end)")->local.trend_WE_loisir
local.trend(mob_loisirs_ts, main = "Tendance locale – LOISIR (hebdomadaire)")->local.trend_loisir
```
L’analyse de la tendance locale met en évidence des changements au cours du temps. Une forte tendance négative est observée au début de la période étudiée, suivie d’un point bas autour de l’année 2021. Ensuite, une reprise progressive est visible, tant pour les jours ouvrables que pour les week-ends, bien que cette reprise soit plus marquée pour les activités de loisirs durant les week-ends.
Donc durant le confinement les gens vont moins au centre commerciaux et font moins de loisir, ce qui coïncide avec le confinement et après lors des réouverture la tendance augmente les gens ressortent aux magasins.
Les résultats du test de tendance générale basé sur bootstrap montrent que la statistique de test est significativement différente de zéro. La distribution bootstrap et le QQ-plot indiquent une bonne approximation par une loi normale, confirmant l’existence d’une tendance significative dans les séries de mobilité liées aux loisirs.
```{r décomposition}
mobw_mm_loisir <- tsd(mobw_loisirs_ts, method = "average", order = 5, times = 3)
plot(mobw_mm_loisir)
mobWE_mm_loisir <- tsd(mobWE_loisirs_ts, method = "average", order = 5, times = 3)
plot(mobWE_mm_loisir)
mob_mm_loisir <- tsd(mob_loisirs_ts, method = "average", order = 5, times = 3)
plot(mob_mm_loisir)
#A regarder si je vais garder ceci ou LOESS sa depend des résultats 
```

La décomposition par moyenne mobile permet de séparer la série de mobilité liée aux commerces et aux loisirs en une composante de tendance et une composante résiduelle.
La composante filtrée met en évidence une tendance de long terme marquée par une chute brutale au début de l’année 2020, suivie d’une phase basse prolongée et d’une reprise progressive à partir de 2021. Cette évolution est observée de manière cohérente pour la série complète ainsi que pour les sous-séries jours ouvrables et week-end.
Les résidus sont globalement centrés autour de zéro et correspondent principalement à des fluctuations de court terme et à des chocs ponctuels, indiquant que la décomposition capture correctement la dynamique principale de la série.

La décomposition par moyenne mobile permet de séparer la série de mobilité liée aux commerces et aux loisirs en une composante de tendance et une composante résiduelle.
La composante filtrée met en évidence une tendance de long terme marquée par une chute brutale au début de l’année 2020, suivie d’une phase basse prolongée et d’une reprise progressive à partir de 2021. Cette évolution est observée de manière cohérente pour la série complète ainsi que pour les sous-séries jours ouvrables et week-end.
Les résidus sont globalement centrés autour de zéro et correspondent principalement à des fluctuations de court terme et à des chocs ponctuels, indiquant que la décomposition capture correctement la dynamique principale de la série.
```{r decomp_LOESS_loisir}
loisir_loess <- tsd(mob_loisirs_ts, method   = "loess", s.window = 53, trend    = TRUE, robust   = TRUE)
plot(loisir_loess, main = "Décomposition LOESS – LOISIR (hebdomadaire, série complète)")

loisir_loess_w <- tsd(mobw_loisirs_ts, method   = "loess", s.window = 53, trend    = TRUE, robust   = TRUE)
plot(loisir_loess_w, main = "Décomposition LOESS – LOISIR (jours ouvrables)")

loisir_loess_WE <- tsd(mobWE_loisirs_ts, method   = "loess", s.window = 53, trend    = TRUE, robust   = TRUE)
plot(loisir_loess_WE, main = "Décomposition LOESS – LOISIR (Week-end)")
```
La décomposition LOESS est privilégiée car elle capture correctement les tendances de long terme et les structures saisonnières sans imposer d’hypothèse linéaire stricte, tout en laissant des résidus faiblement structurés.
La COVID-19 a provoqué une rupture majeure dans la mobilité liée aux loisirs,
cet impact est visible à la fois sur la tendance de long terme et les variations à court terme,
tandis que la structure saisonnière persiste, bien que temporairement perturbée.
La décomposition LOESS est privilégiée car elle capture correctement les tendances de long terme et les structures saisonnières sans imposer d’hypothèse linéaire stricte, tout en laissant des résidus faiblement structurés.
```{r extraction des résidus }
mts_loisir <- tseries(loisir_loess)
plot(mts_loisir)

mts_loisir_w<- tseries(loisir_loess_w)
plot(mts_loisir_w)

tseries(loisir_loess_WE)->mts_loisir_WE
plot(mts_loisir_WE)

```
Les résidus sont très négatifs au début (dans les 3 cas), puis reviennent vers une zone plus stable.
La saisonnalité est bien visible et assez régulière.
La tendance monte puis forme un plateau vers la fin.
Et donc les restriction du confinnement ont fait que les gens fréquentaient moins les commerces et leurs loisirs et petit à petit ils ont put  reprendre leusr activité normalement.
```{r}
acf(mts_loisir[, "trend"])
acf(mts_loisir_w[, "trend"])
acf(mts_loisir_WE[, "trend"])
```
L’autocorrélation élevée et persistante de la composante de tendance indique une forte dépendance temporelle, confirmant le caractère non stationnaire de la série, principalement induit par la rupture structurelle associée à la pandémie de COVID-19.
```{r}
spectrum(mts_loisir[, "trend"], spans = c(5,7))
spectrum(mts_loisir_w[, "trend"], spans = c(5,7))
spectrum(mts_loisir_WE[, "trend"], spans = c(5,7))

```
Le spectre est fortement concentré aux basses fréquences. Il n’y a pas de pic marqué à des fréquences élevées. La puissance spectrale décroît rapidement quand la fréquence augmente.
Ce qui confirme que la tendance est dominée par des variations lentes, sans périodicité courte marquée.
Il n’y a pas de cycle régulier hebdomadaire ou saisonnier dans la tendance ils ont été correctement séparés dans la composante seasonal lors de la décomposition LOESS.
```{r}
acf(mts_loisir[, "residuals"])
acf(mts_loisir_w[, "residuals"])
acf(mts_loisir_WE[, "residuals"])

```
Les résidus ne sont pas 100% bruit blanc il reste une dépendance à court terme 
Ce qui est logique, parce que les mesures ne sont pas mise un seul jour, ça crée des épisodes de plusieurs jours/semaines donc autocorrélation.

Je garde la décomposition LOESS car elle capture une tendance non linéaire et robuste aux ruptures (chocs COVID), tout en séparant proprement la saisonnalité et les anomalies résiduelles.

```{r TRAVAIL}
mobwts_travail <- ts(mobw$workplaces_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobwts_travail, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobw_travail_ts
plot(mobw_travail_ts)

mobWEts_travail <- ts(mobWE$workplaces_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobWEts_travail, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobWE_travail_ts
plot(mobWE_travail_ts)
```

```{r Autocorrélation TRAVAIL}
acf(mobw_travail_ts)
acf(mobWE_travail_ts)
```

```{r RESIDENCE}
mobwts_residence <- ts(mobw$residential_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobwts_residence, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobw_residence_ts
plot(mobw_residence_ts)

mobWEts_residence <- ts(mobWE$residential_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobWEts_residence, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobWE_residence_ts
plot(mobWE_residence_ts)
```

```{r Autocorrélation RESIDENCE}
acf(mobw_residence_ts)
acf(mobWE_residence_ts)
```

```{r}
mobw_mm_residence <- tsd(mobw_residence_ts, method = "average", order = 5, times = 3)
plot(mobw_mm_residence)

mobWE_mm_residence <- tsd(mobWE_residence_ts, method = "average", order = 5, times = 3)
plot(mobWE_mm_residence)
```

```{r}
mobwts_transport <- ts(mobw$transit_stations_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobwts_transport, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobw_transport_ts
plot(mobw_transport_ts)

mobWEts_transport <- ts(mobWE$transit_stations_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobWEts_transport, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobWE_transport_ts
plot(mobWE_transport_ts)


mobts_transport <- ts(mob$transit_stations_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobts_transport, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mob_transport_ts
plot(mob_transport_ts)
```

```{r Autocorrélation TRANSPORT}
acf(mobw_transport_ts)
acf(mobWE_transport_ts)
```

## Conclusion

<!--% Lorsque toutes les analyses sont réalisées, terminez ce bloc-notes avec 3 à 6 phrases de conclusion en rapport avec ce que vous avez observé dans vos analyses. Quels sont les éléments les plus pertinents que vous retenez ? -->

...vos conclusions ici...
