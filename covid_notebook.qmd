---
title: "___"
author: "___"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
editor: visual
lang: fr
---410
---

<!--# Ceci est un commentaire. -->

<!--% Ceci est une consigne. Ne jamais modifier ni déplacer les consignes dans le document ! -->

<!--% Complétez le titre et le nom des auteurs (auteur1, auteur2, auteur3 et auteur 4) dans l'entête YAML.-->

## Introduction et but

<!--% Rédigez une courte introduction de 3 ou 5 phrases qui présente vos données. Ajoutez une phrase de but. Vous devez citer la bibliographie en utilisant le formatage Markdown ad hoc et en incluant votre référence au format bibtex dans le fichier references.bib. -->

... Introduction et but...

## Matériel et méthodes

<!--% Indiquez ici d'où viennent les données et aussi quel logiciel (et version) vous utilisez pour les analyses. Inspirez-vous des projets déjà réalisés. -->

...Matériel et méthodes...

## Analyses

<!--% Lisez bien les éléments devant guider votre analyse proposée dans le README.-->

```{r setup, include=FALSE}
# Nécessaire pour les tests SDD, ne pas utiliser dans un "vrai" projet
if (!"tools:tests" %in% search())
  source(here::here("tests/tools_tests.R"), attach(NULL, name = "tools:tests"))
# Configuration de l'environnement
SciViews::R("ts")
```

<!--% Ajoutez le nombre de chunks que vous souhaitez. Répartissez-vous le travail correctement. Structurez la section en partie avec des titres explicites de niveau trois.-->

```{r Importation mobility wallonia rds}

read("data/mobility_wallonia.rds") -> mob
mobw <- mob
mobw$weekdays <- weekdays(as.POSIXct(mobw$date))
mobw[mobw$weekdays == "Saturday" | mobw$weekdays == "Sunday", 2:7] <- NA # Contient que les 5 jours de la semaine
mobw_ts <- ts(mobw$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
mobw_ts2 <- aggregate(mobw_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)

# Contient que le week-end
mobWE <- mob
mobWE$weekdays <- weekdays(as.POSIXct(mobWE$date))
mobWE[mobWE$weekdays != "Saturday" & mobWE$weekdays != "Sunday", 2:7] <- NA
mobWE_ts <- ts(mobWE$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
mobWE_ts2 <- aggregate(mobWE_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
```

#Présentation du jeux de données ##Mobilité lié aux Commerces et aux loisirs

```{r loisir et commerce présentation des données}
# Série brut, semaine
mob_loisir_brut <- ts( mob$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
plot( mob_loisir_brut, main = "Commerces et loisirs - Semaine",  ylab = "% de changement par rapport à la référence", xlab = "Temps")

#Jours ouvrables
mobw_loisir_brut <- ts(mobw$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
plot(mobw_loisir_brut, main = "Commerces et loisirs - Jours ouvrables",ylab = "% de changement par rapport à la référence", xlab = "Temps")

#WE
mobWE_loisir_brut  <- ts(mobWE$retail_and_recreation_percent_change_from_baseline,   start = c(2020, 46), frequency = 365)
plot(mobWE_loisir_brut, main = "Commerces et loisirs - week-end uniquement", ylab = "% de changement par rapport à la référence", xlab = "Temps")

#Jours ouvrable et WE supperposé 
plot(mobw_loisir_brut, main = "Commerces et loisirs  – comparaison jours ouvrables / week-end ", xlab = "Temps", ylab = "% vs baseline", lwd = 2)
lines(mobWE_loisir_brut, lwd = 2, lty = 2)
legend("topright", legend = c("Jours ouvrables", "Week-end"), lty = c(1,2), lwd = 2, bty = "n")

```

La mobilité liée aux commerces et aux loisirs montre une chute marquée au début de l’année 2020, particulièrement prononcée durant les week-ends. La reprise est progressive à partir de mi-2021, avec une variabilité plus importante observée pour les jours de week-end que pour les jours de semaine.

Et quand on supperpose l’évolution de la mobilité liée aux commerces et aux loisirs en Wallonie entre 2020 et 2022, en distinguant les jours ouvrables et les week-ends. On observe une chute brutale de la mobilité au début de l’année 2020, plus marquée durant les week-ends que durant les jours ouvrables. La reprise est progressive mi-2021, avec des valeurs qui restent globalement négatives pendant une longue période. Puis elle se stabilise et devient majoritairement positive, surtout les week-ends, qui présentent une variabilité plus importante que les jours de semaine. #Analyse : ##Loisir et commerces ###Préparation des données

```{r LOISIR Hebdomadaire }
#Jours ouvrables
mobwts_LOISIR <- ts(mobw$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobwts_LOISIR, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobw_loisirs_ts
plot(mobw_loisirs_ts)
#Week-end
mobWEts_LOISIR <- ts(mobWE$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobWEts_LOISIR, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobWE_loisirs_ts
plot(mobWE_loisirs_ts)

#semaine compléte
mobts_LOISIR <- ts(mob$retail_and_recreation_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobts_LOISIR, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mob_loisirs_ts
plot(mob_loisirs_ts)

#Jours ouvrable et WE suppérposé 
plot(mobwts_LOISIR, main = "Commerces et loisirs  – comparaison jours ouvrables / week-end (hebdomadaire) ", xlab = "Temps", ylab = "% vs baseline", lwd = 2)
lines(mobWEts_LOISIR, lwd = 2, lty = 2)
legend("topright", legend = c("Jours ouvrables", "Week-end"), lty = c(1,2), lwd = 2, bty = "n")

```

```{r Autocorrélation LOISIR}
acf(mobw_loisirs_ts, main = "ACF – LOISIR (jours de semaine, hebdomadaire)")
acf(mobWE_loisirs_ts,main = "ACF – LOISIR (week-end, hebdomadaire)")
acf(mob_loisirs_ts,main = "ACF – LOISIR (série complète, hebdomadaire)")
```

```{r tendance locale et générale de loisir}
trend.test(mobw_loisirs_ts, R=999)->trend.test_w_loisir
plot(trend.test_w_loisir)
trend.test_w_loisir
trend.test(mobWE_loisirs_ts, R=999)->trend.test_WE_loisir
plot(trend.test_WE_loisir)
trend.test_WE_loisir
trend.test(mob_loisirs_ts,R=999)->trend.test_loisir
plot(trend.test_loisir)
trend.test_loisir

local.trend(mobw_loisirs_ts,  main = "Tendance locale – LOISIR (jours ouvrables)")->local.trend_w_loisir
local.trend(mobWE_loisirs_ts, main = "Tendance locale – LOISIR (week-end)")->local.trend_WE_loisir
local.trend(mob_loisirs_ts, main = "Tendance locale – LOISIR (hebdomadaire)")->local.trend_loisir
```

```{r décomposition}
mobw_mm_loisir <- tsd(mobw_loisirs_ts, method = "average", order = 5, times = 3)
plot(mobw_mm_loisir)
mobWE_mm_loisir <- tsd(mobWE_loisirs_ts, method = "average", order = 5, times = 3)
plot(mobWE_mm_loisir)
mob_mm_loisir <- tsd(mob_loisirs_ts, method = "average", order = 5, times = 3)
plot(mob_mm_loisir)
#A regarder si je vais garder ceci ou LOESS sa depend des résultats 
```

```{r decomp_LOESS_loisir}
loisir_loess <- tsd(mob_loisirs_ts, method   = "loess", s.window = 53, trend    = TRUE, robust   = TRUE)
plot(loisir_loess, main = "Décomposition LOESS – LOISIR (hebdomadaire, série complète)")

loisir_loess_w <- tsd(mobw_loisirs_ts, method   = "loess", s.window = 53, trend    = TRUE, robust   = TRUE)
plot(loisir_loess_w, main = "Décomposition LOESS – LOISIR (jours ouvrables)")

loisir_loess_WE <- tsd(mobWE_loisirs_ts, method   = "loess", s.window = 53, trend    = TRUE, robust   = TRUE)
plot(loisir_loess_WE, main = "Décomposition LOESS – LOISIR (Week-end)")
```

```{r extraction des résidus }
mts_loisir <- tseries(loisir_loess)
plot(mts_loisir)

mts_loisir_w<- tseries(loisir_loess_w)
plot(mts_loisir_w)

tseries(loisir_loess_WE)->mts_loisir_WE
plot(mts_loisir_WE)

```

```{r}
acf(mts_loisir[, "trend"])
acf(mts_loisir_w[, "trend"])
acf(mts_loisir_WE[, "trend"])
```

```{r}
spectrum(mts_loisir[, "trend"], spans = c(5,7))
spectrum(mts_loisir_w[, "trend"], spans = c(5,7))
spectrum(mts_loisir_WE[, "trend"], spans = c(5,7))

```

```{r}
acf(mts_loisir[, "residuals"])
acf(mts_loisir_w[, "residuals"])
acf(mts_loisir_WE[, "residuals"])

```

```{r TRAVAIL}
mobwts_travail <- ts(mobw$workplaces_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobwts_travail, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobw_travail_ts
plot(mobw_travail_ts)

mobWEts_travail <- ts(mobWE$workplaces_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobWEts_travail, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobWE_travail_ts
plot(mobWE_travail_ts)
```

```{r Autocorrélation TRAVAIL}
acf(mobw_travail_ts)
acf(mobWE_travail_ts)
```

```{r visualisation données résidence brutes}
mob_ts_residence_brute <- ts(mob$residential_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
plot(mob_ts_residence_brute,
     main = "Résidence – semaines entières",
     xlab = "Temps", ylab = "% changement vs référence") #Visualisation données résidence pour semaine complètes

mobw_ts_residence_brute <- ts(mobw$residential_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
plot(mobw_ts_residence_brute,
     main = "Résidence – jours ouvrables",
     xlab = "Temps", ylab = "% changement vs référence") #Visualisation données résidence pour jours ouvrables

mobWE_ts_residence_brute <- ts(mobWE$residential_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
plot(mobWE_ts_residence_brute,
     main = "Résidence – week-ends",
     xlab = "Temps", ylab = "% changement vs référence") #Visualisation données résidence pour week-ends

#Comparaison jours ouvrables et semaines 
plot(mobw_ts_residence_brute, main = "Résidence – comparaison jours ouvrables / week-end)", xlab = "Temps", ylab = "% vs référence", lwd = 2)
lines(mobWE_ts_residence_brute, lwd = 2, lty = 2)
legend("topright", legend = c("Jours ouvrables", "Week-end"), lty = c(1,2), lwd = 2, bty = "n")

```

```{r RESIDENCE}
mobts_residence <- ts(mob$residential_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobts_residence, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mob_residence_ts
plot(mob_residence_ts)

mobwts_residence <- ts(mobw$residential_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobwts_residence, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobw_residence_ts
plot(mobw_residence_ts)

mobWEts_residence <- ts(mobWE$residential_percent_change_from_baseline, start = c(2020, 46), frequency = 365)
aggregate(mobWEts_residence, 52, FUN = collapse::fmean, ts.eps = 1/52) ->mobWE_residence_ts
plot(mobWE_residence_ts)

plot(mobwts_residence, main = "Résidence – comparaison jours ouvrables / week-end (hebdomadaire)", xlab = "Temps", ylab = "Variation (%) vs référence", lwd = 2)
lines(mobWEts_residence, lwd = 2, lty = 2)
legend("topright", legend = c("Jours ouvrables", "Week-end"), lty = c(1,2), lwd = 2, bty = "n")
```

```{r Autocorrélation RESIDENCE}
acf(mobw_residence_ts, main = "ACF – Résidence (jours ouvrables, hebdo)")
acf(mobWE_residence_ts, main = "ACF – Résidence (week-ends, hebdo)")
acf(mob_residence_ts, main = "ACF – Résidence (semaines complètes, hebdo)")

set.seed(123)
tt_residence_w <- trend.test(mobw_residence_ts, R = 999)
tt_residence_w
plot(tt_residence_w)

lt_residence_w <- local.trend(mobw_residence_ts, main="Test de tendance locale - résidence - jours ouvrables")


tt_residence_WE <- trend.test(mobWE_residence_ts, R = 999)
tt_residence_WE
plot(tt_residence_WE)

lt_residence_WE <- local.trend(mobWE_residence_ts, main="Test de tendance locale - résidence - week-ends")
```

```{r}
mobw_mm_residence <- tsd(mobw_residence_ts, method = "average", order = 5, times = 3)
plot(mobw_mm_residence)

mobWE_mm_residence <- tsd(mobWE_residence_ts, method = "average", order = 5, times = 3)
plot(mobWE_mm_residence)

residencew_filtered <- extract(mobw_mm_residence, components = "filtered")
plot(residencew_filtered,
     main = "Résidence – composante filtrée (moyenne mobile)",
     xlab = "Temps", ylab = "Variation (%) vs référence")


residencew_filtered <- extract(mobw_mm_residence, components = "filtered")

acf(residencew_filtered, main = "ACF de la composante filtrée – Résidence (jours ouvrables)")

```

```{r TRANSPORT - Presentation de données sur les arrets de transport en époque de Covid}
mob_ts_transport_brut <- ts(mobw$transit_stations_percent_change_from_baseline, start = c(2020, 46), frequency = 365) 
mob_ts_transport<-aggregate(mob_ts_transport_brut, 52, FUN = collapse::fmean, ts.eps = 1/52) 
plot(mob_ts_transport, main="Arrets de transport par semaine",xlab="Temps", ylab="Pourcentage de changement par rapport à la référence") #pour la semaine complète 

mobDS_ts_transport_brut <- ts(mobWE$transit_stations_percent_change_from_baseline, start = c(2020, 46), frequency = 365) 
mobDS_ts_transport<-aggregate(mobDS_ts_transport_brut, 52, FUN = collapse::fmean, ts.eps = 1/52) 
plot(mobDS_ts_transport, main = "Arrêts de transport en Début de Semaine", xlab = "Temps", ylab = "Pourcentage de changement par rapport à la référence")#pour le début de semaine de lundi à vendredi 

mobFS_ts_transport_brut <- ts(mob$transit_stations_percent_change_from_baseline, start = c(2020, 46), frequency = 365) 
mobFS_ts_transport<-aggregate(mobFS_ts_transport_brut, 52, FUN = collapse::fmean, ts.eps = 1/52) 
plot(mobFS_ts_transport, main = "Arrêts de transport en Fin de Semaine", xlab = "Temps", ylab = "Pourcentage de changement par rapport à la référence")#pour la fin de la semaine pendant le samedi et le dimanche 

plot(mob_ts_transport_brut, main = "Comparaison entre le Début de semaine et la Fin de la semaine", xlab = "Temps", ylab = "Pourcentage contre baseline", lwd = 2) 
lines(mob_ts_transport_brut, lwd = 2, lty = 0.5) 
legend("topright", legend = c("Début Semaine", "Fin Semaine"), lty = c(1,2), lwd = 0.5, bty = "n")#Superposition de début de semaine et fin de semaine  
```

On peut voir qu'au début du 2020 il y a une forte diminution, mais très peu après il y a une grande augmentation successive. En 2021, il y à nouveau une chute mais beaucoup moins drastique qu'avant (1/2 par rapport à l'année dernière). Ensuite, on voit une récupération encore plus forte qu'avant. Cependant, en 2022 il y a encore une autre chute de même intensité or qui dure beaucoup moins longtemps. Cette fois ci on perçoit une récupération complète de quasi 60% qui est maintenu dans le temps.

```{r Autocorrélation TRANSPORT}
acf(mob_ts_transport, main = "ACF – TRANSPORT (tos les jours de la semaine, hebdomadaire)") 
acf(mobDS_ts_transport,main = "ACF – TRANSPORT (Début semaine, hebdomadaire)") 
acf(mobFS_ts_transport,main = "ACF – TRANSPORT (Fin Semaine, hebdomadaire)")  


```

```{r tendance locale et générale dans les arrêts de transport}
trend.test(mob_ts_transport, R=999)->trend.test_S_transport 
plot(trend.test_S_transport) 
trend.test_S_transport 

trend.test(mobDS_ts_transport, R=999)->trend.test_DS_transport
plot(trend.test_DS_transport) 
trend.test_DS_transport 

trend.test(mobFS_ts_transport,R=999)->trend.test_FS_transport 
plot(trend.test_FS_transport) 
trend.test_FS_transport 

local.trend(mob_ts_transport, main = "Tendance locale – TRANSPORT (jours ouvrables)")->local.trend_transport 
local.trend(mobDS_ts_transport, main = "Tendance locale – TRANSPORT (week-end)")->local.trend_DS_transport 
local.trend(mobFS_ts_transport, main = "Tendance locale – TRANSPORT (hebdomadaire)")->local.trend_FS_transport  

```

```{r décomposition de données de arrêts de Transport}
mob_mm_transport <- tsd(mob_ts_transport, method = "average", order = 5, times = 3) 
plot(mob_mm_transport) 

mobDS_mm_transport <- tsd(mobDS_ts_transport, method = "average", order = 5, times = 3) 
plot(mobDS_mm_transport) 

mobFS_mm_transport <- tsd(mobFS_ts_transport, method = "average", order = 5, times = 3) 
plot(mobFS_mm_transport)  


```

```{r decomposition en LOESS des arrêts de transport}
transport_loess <- tsd(mob_ts_transport, method = "loess", s.window = 53, trend = TRUE, robust = TRUE) 
plot(transport_loess, main = "Décomposition LOESS de TRANSPORT (semaine complète)") 

transportDS_loess <- tsd(mobDS_ts_transport, method = "loess", s.window = 53, trend = TRUE, robust = TRUE) 
plot(transportDS_loess, main = "Décomposition LOESS de TRANSPORT (Debut de semaine: de lundi à vendredi)") 

transportFS_loess <- tsd(mobFS_ts_transport, method = "loess", s.window = 53, trend = TRUE, robust = TRUE) 
plot(transportFS_loess, main = "Décomposition LOESS de TRANSPORT (Fin de semaine: samedi et dimanche)")  

```

```{r extraction des résidus de Transport }
mts_transport <- tseries(transport_loess) 
plot(mts_loisir) 

mts_transportDS <- tseries(transportDS_loess) 
plot(mts_transportDS) 

mts_transportFS <- tseries(transportFS_loess) 
plot(mts_transportFS)  

```

```{r}
acf(mts_transport[, "trend"]) 
acf(mts_transportDS[, "trend"]) 
acf(mts_transportFS[, "trend"])  

```

```{r}
spectrum(mts_transport[, "trend"], spans = c(5,7)) 
spectrum(mts_transportDS[, "trend"], spans = c(5,7)) 
spectrum(mts_transportFS[, "trend"], spans = c(5,7))  


```

```{r}
acf(mts_transport[, "residuals"]) 
acf(mts_transportDS[, "residuals"]) 
acf(mts_transportFS[, "residuals"])  
```

## Conclusion

<!--% Lorsque toutes les analyses sont réalisées, terminez ce bloc-notes avec 3 à 6 phrases de conclusion en rapport avec ce que vous avez observé dans vos analyses. Quels sont les éléments les plus pertinents que vous retenez ? -->

...vos conclusions ici...
